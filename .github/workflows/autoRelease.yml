# This action automatically creates a release when pushing to main (in the src folder).
# It also zips the contents of the src folder and uploads it as an artifact, which is included in the release.

  name: Automatically Release

  on:
    push:
      branches:
        - main
      paths:
        - "src/**"
  
  jobs:
    build:
      runs-on: ubuntu-latest
  
      steps:
        - name: Checkout code
          uses: actions/checkout@v3.5.3
  
        - name: Install zip
          run: sudo apt-get install zip
  
        - name: Read version from Functions.ps1
          id: vars
          run: |
            echo "version=$(grep -oP '(?<=\$Version = \")[^\"]*' ./src/scripts/Functions.ps1)" >> $GITHUB_OUTPUT
            echo ${{ steps.vars.outputs.version }}

        - name: List files
          run: ls -R
        - name: Convert Line Endings
          run: dos2unix README.md CHANGELOG.md

        - name: Display README Before
          run: cat README.md
        
        - name: Replace Changelog
          run: |
            sed -i '/<!-- changelog content -->/r CHANGELOG.md' README.md
          shell: bash
        
        - name: Display README After
          run: cat README.md
        
        - name: Add changelog to readme
          run: |
            sed -i '/<!-- changelog content -->/r CHANGELOG.md' README.md
            git config --local user.email "actions@github.com"
            git config --local user.name "GitHub Actions"
            git add README.md
            git commit -m "Update changelog in README for ${{ steps.vars.outputs.version }}"
            git push        
        
        - name: Package CCStopper folder
          run: |
            mv 'src' 'CCStopper ${{ steps.vars.outputs.version }}'
            zip -r CCStopper.zip 'CCStopper ${{ steps.vars.outputs.version }}'
  
        - name: Create Release
          uses: softprops/action-gh-release@v0.1.15
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          with:
            body: |
              > ðŸ¤– This is an automated release. I recommend the [one-line commands](https://github.com/eaaasun/CCStopper#powershell-) instead for a better user experience.
  
              ## Changelog
            tag_name: auto-${{ steps.vars.outputs.version }}
            name: ${{ steps.vars.outputs.version }}
            files: ./CCStopper.zip
            append_body: ./CHANGELOG.md
  
  permissions:
    contents: write
  